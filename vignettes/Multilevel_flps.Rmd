---
title: "Multilevel FLPS"
description: >
  FLPS based on multilevel structure.
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multilevel FLPS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = F,
  collapse = TRUE,
  comment = "#>",
  # fig.width = 4,
  out.width = '55%'
)
```


```{r}
library(flps)
```

## Multilevel FLPS (being tested)

### FLPS based on multilevel Latent Class analysis

```{r echo = F, eval = T}
# fit <- readRDS("results/LCA_2.RDS")
```

```{r}
binary <- binary %>%
  group_by(schid) %>%
  mutate(cm_sex = mean(sex),
         cm_race = mean(race))

res <- runFLPS(
  inp_data = binary,
  # complied_stan = importModel('irt'),
  outcome  = "Y",
  trt      = "trt",
  covariate =
    list(c("sex","race","pretest","stdscore"), # Level 1 covariates
         c("cm_sex","cm_race")),               # Level 2 covariates
  lv_type = "lca",
  multilevel = T,
  lv_model = "F =~ q1 + q2 + q3 + q4 + q5 + q6 + q7 + q8 + q9 + q10",
  nclass = 2,
  group_id = "schid",
  stan_options = list(iter = 100, cores = 1, chains = 1)
)
```


```{r eval = F}
# est <- summary(fit)$summary %>% data.frame()
# 
# est$par_name <- rownames(est)
# 
# # Tau0
# est %>% 
#   filter(str_detect(par_name, "^b00")) %>% 
#   select(mean, sd, X2.5., X97.5., par_name) %>% 
#   mutate_if(is.numeric, round, 3)
# 
# # Tau1
# est %>% 
#   filter(str_detect(par_name, "^b01")) %>% 
#   select(mean, sd, X2.5., X97.5., par_name) %>% 
#   mutate_if(is.numeric, round, 3)
# 
# # Covariate effects on Y
# est %>% 
#   filter(str_detect(par_name, "^betaY")) %>% 
#   select(mean, sd, X2.5., X97.5., par_name) %>% 
#   mutate_if(is.numeric, round, 3)
# 
# # Covariate effects on Class memberships
# est %>% 
#   filter(str_detect(par_name, "^betaU")) %>% 
#   select(mean, sd, X2.5., X97.5., par_name) %>% 
#   mutate_if(is.numeric, round, 3)
# 
# # Class 1 profiles
# est %>% 
#   filter(str_detect(par_name, "^p\\[1")) %>% 
#   select(mean, sd, X2.5., X97.5., par_name) %>% 
#   mutate_if(is.numeric, round, 3)
# 
# # Class 2 profiles
# est %>% 
#   filter(str_detect(par_name, "^p\\[2")) %>% 
#   select(mean, sd, X2.5., X97.5., par_name) %>% 
#   mutate_if(is.numeric, round, 3)
# 
# # Class membership
# classp <- est %>% 
#   filter(str_detect(par_name, "^nu")) %>% 
#   select(mean, sd, X2.5., X97.5., par_name) %>% 
#   mutate_if(is.numeric, round, 3) %>% pull(mean)
# 
# class_membership <- as.numeric(classp > 0.5)
# table(class_membership)
```

