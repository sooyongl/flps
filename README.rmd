---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = F,fig.width = 4)
library(flps)
```

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/flps)](https://CRAN.R-project.org/package=flps)
<!-- badges: end -->



## Fully Latent Principal Stratification (FLPS)^[**Acknowledgements.** This package is supported by the Institute of Education Sciences, U.S. Department of Education, through Grant R305D210036.]

Fully Latent Principal Stratification (**FLPS**) is an extension of principal stratification.

## Installation

Install the latest release from CRAN or git repository:

```{r}
devtools::install_github("sooyongl/flps")
```


- Documentation is available [here](https://sooyongl.github.io/flps/).

- For compiling errors on Windows, see the relevant guide.
The documentation is available at [here](https://github.com/stan-dev/rstan/wiki/Configuring-C---Toolchain-for-Windows#r-42).


## Basic working example

### Load Example Data

```{r eval = T}
set.seed(10000)
data(binary)
```


- `binary`: a data frame containing all the data for FLPS. It is used in `runFLPS` function.
- This data will be converted to a list of data for [`rstan`](https://github.com/stan-dev/rstan) package.
- For latent variable models, Rasch, 2PL, GRM, and SEM (one-factor CFA) are available.


```{r eval = T}
# Input data matrix
data.table::data.table(binary)
```



### Model Fitting with FLPS

- `runFLPS` internally converts binary into the data format for rstan and executes FLPS.

- To avoid re-compiling the Stan code each time, pre-compile it using `modelBuilder()`, which stores the stanmodel object in the `flps` directory, accelerating subsequent analyses.

```{r eval = F}
modelBuilder(type = "rasch")
```

- In case of errors, try the latest `rstan` and `StanHeaders` packages.

```{r eval = F}
remove.packages(c("rstan", "StanHeaders"))
install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
```

Now, execute your FLPS model.

```{r eval = T, cache=TRUE}
# Subset of data: 1000 students
binary <- binary[c(sample(which(binary$trt == 1), 500), sample(which(binary$trt == 0), 500)),]

res <- runFLPS(
  inp_data = binary,
  outcome = "Y",
  trt = "trt",
  covariate = c("sex","race","pretest","stdscore"),
  lv_type = "rasch",
  lv_model = "F =~ q1 + q2 + q3 + q4 + q5 + q6 + q7 + q8 + q9 + q10",
  stan_options = list(iter = 5000, cores = 1, chains = 2)
)
```

### Results

Retrieve summaries and visualize results with the following:

```{r eval = T}

summary(res, type = "causal")

```


The `flps_plot()` shows the plot related to FLPS models

```{r eval = F}

flps_plot(res, type = "causal")

```

```{r eval = T, echo=FALSE, fig.align='center', fig.cap='', out.width='60%'}
# a1 <- flps_plot(res, type = "causal")
# ggplot2::ggsave("man/figures/causal_1.png", a1)
knitr::include_graphics('man/figures/causal_1.png')
```



```{r eval = F}

flps_plot(res, type = "latent")

```


```{r eval = T, echo=FALSE, fig.align='center', fig.cap='', out.width='60%'}
# a1 <- flps_plot(res, type = "latent")
# ggplot2::ggsave("man/figures/latent_1.png", a1)
knitr::include_graphics('man/figures/latent_1.png')
```



